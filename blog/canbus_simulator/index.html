<!DOCTYPE html><html lang="en"><head><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="icon" href="/favicon.ico"/><title>Virtual CAN-BUS simulator (Virtual ECU)</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@brsc2909"/><meta name="twitter:creator" content="@brsc2909"/><meta property="og:title" content="Virtual CAN-BUS simulator (Virtual ECU)"/><meta property="og:image" content="https://blog.brendanscullion.com/_next/image?url=https%3A%2F%2Fcdn.hashnode.com%2Fres%2Fhashnode%2Fimage%2Funsplash%2FKVPRz5JEDbc%2Fupload%2Fv1652106957021%2FtZQ5ZUVIo.jpeg%3Fw%3D1600%26h%3D840%26fit%3Dcrop%26crop%3Dentropy%26auto%3Dcompress%2Cformat%26format%3Dwebp&amp;w=1920&amp;q=75"/><meta property="og:locale" content="en"/><meta property="og:site_name" content="BlackShore Technology"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/97ba6f2c52508b1c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/97ba6f2c52508b1c.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ceafdc2a5aec27f5.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-e1a26ccba1e059ae.js" defer=""></script><script src="/_next/static/chunks/pages/_app-46193ce66c80104f.js" defer=""></script><script src="/_next/static/chunks/672-a3b45081abb2e7a4.js" defer=""></script><script src="/_next/static/chunks/441-77e562cc26b53af2.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-df22efd518924fb4.js" defer=""></script><script src="/_next/static/u0JvOxob0c2afmijk8C1k/_buildManifest.js" defer=""></script><script src="/_next/static/u0JvOxob0c2afmijk8C1k/_ssgManifest.js" defer=""></script><style id="__jsx-4057204961">.navbar.jsx-4057204961 li:not(:first-child){margin-top:0;}.navbar.jsx-4057204961 li:not(:last-child){margin-right:1.25rem;}</style></head><body><div id="__next"><div><div class="bg-gray-900"><div class="max-w-screen-lg mx-auto px-3 py-3 undefined"><div class="jsx-4057204961 flex flex-wrap justify-between items-center"><div class="jsx-4057204961"><a href="/"><span class="text-gray-100 inline-flex items-center font-semibold text-xl"><svg clip-rule="evenodd" fill-rule="evenodd" width="32" height="32" image-rendering="optimizeQuality" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" viewBox="0 0 110.99997 120.00004" version="1.1" id="svg68" xmlns="http://www.w3.org/2000/svg"><defs id="defs58"><linearGradient gradientUnits="userSpaceOnUse" id="a" x1="87.309998" x2="7662.6299" y1="3022.4099" y2="14087.64"><stop offset="0" stop-color="#004790" id="stop53"></stop><stop offset="1" stop-color="#1297e0" id="stop55"></stop></linearGradient></defs><g id="g66" transform="scale(0.008,0.0077)"><path d="M 6348.16,5590.89 8916.54,7073.7 10687.81,6051.09 V 3085.38 L 5343.87,0 3127.55,1279.53 8471.59,4364.91 Z" fill="#0067b0" id="path60"></path><path d="M 7912.25,7653.67 0,3085.38 V 6051.09 L 8536.06,10979.42 5343.87,12822.36 0,9736.98 v 2604.18 l 5343.87,3085.29 5343.94,-3085.29 v -3085.1 z" fill="url(#a)" id="path62"></path><path d="M 8471.59,4364.91 10687.81,3085.38 7791.94,3972.5 Z" fill="#003780" id="path64"></path></g></svg></span></a></div><nav class="jsx-4057204961"><ul class="jsx-4057204961 navbar flex items-center font-medium text-xl text-gray-300"><li><a href="/about/">About us</a></li><li><a>Services</a></li><li><a href="/blog/">Blog</a></li></ul></nav></div></div></div><div class="max-w-screen-lg mx-auto px-3 py-8 prose prose-slate"><div class="mb-12 text-center"><h2 class="text-4xl text-gray-900 font-bold">Virtual CAN-BUS simulator (Virtual ECU)</h2></div><article><img src="https://blog.brendanscullion.com/_next/image?url=https%3A%2F%2Fcdn.hashnode.com%2Fres%2Fhashnode%2Fimage%2Funsplash%2FKVPRz5JEDbc%2Fupload%2Fv1652106957021%2FtZQ5ZUVIo.jpeg%3Fw%3D1600%26h%3D840%26fit%3Dcrop%26crop%3Dentropy%26auto%3Dcompress%2Cformat%26format%3Dwebp&amp;w=1920&amp;q=75" alt="Virtual CAN-BUS simulator (Virtual ECU)"/><div>May 1, 2020</div><div><p>While developing some monitoring application for a Raspberry-Pi car computer, I found that writing code on my laptop while sitting in the front seat of my car is not the most productive way to do things. What&#39;s needed is some sort of virtual ECU, and i have just the solution. </p>
<h4 id="in-short-my-solution-is-this">In short my solution is this:</h4>
<ol>
<li><p>Take a can recording of the car starting up and running for a little while</p>
</li>
<li><p>Create a virtual can network device</p>
</li>
<li><p>replay the recording on an infinite loop</p>
</li>
<li><p>package it up nicely so that I can start the simulation on demand
<img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1652107126520/ODP7DeD6f.gif" alt="cansim-demo-2.gif"></p>
</li>
<li><h3 id="record-some-data">Record Some Data</h3>
<p>This may be different for other cars but for my disco 3, I need to wait 5 minutes after turning the car off for the ECU to go to sleep. 
Once the ECU is asleep I start the recording.</p>
</li>
</ol>
<pre><code class="language-bash">candump can0 -l
</code></pre>
<p>I start the car and let it run for 5 minutes or so, later on I’ll redo this and take the car for a spin around the town but for now this is enough for me. so I <code>CTL-C</code> the recording and I get a file named <code>candump-2020-04-14_202239.log</code>. I rename this to something with a little more meaning (“candump-landrover-discovery-3-vcan0.log”)</p>
<ol start="2">
<li><h3 id="configure-virtual-can-device">Configure Virtual CAN device</h3>
The vcan device is basically another network device so configuring it is pretty straight forward.</li>
</ol>
<pre><code class="language-bash">sudo modprobe vcan
sudo ip link add dev vcan0 type vcan
sudo ip link set up vcan0
</code></pre>
<ol start="3">
<li><h3 id="replay-can-recording">Replay CAN Recording</h3>
Now i just need to replay my recording back into vcan0.</li>
</ol>
<pre><code class="language-bash">canplayer -I candump-landrover-discovery-3-vcan0.log -l i vcan0=slcan0
</code></pre>
<p>By default canplayer will replay the file via the same device that it was captured on (<code>slcan0</code>). to get around this i need to specify the <code>vcan0</code> as new device, hence <code>vcan0=slcan0</code></p>
<ol start="4">
<li><h3 id="create-cansim-service">Create cansim service</h3>
Finally I want to be able to start the simulation on demand. I do this by creating a systemd service config</li>
</ol>
<pre><code class="language-bash">sudo vim /lib/systemd/system/cansim.service
</code></pre>
<pre><code class="language-bash">[Unit]
Description=Canbus simulator
After=network.target

[Service]
Label=cansim
Type=exec
Environment=CANDATA=/mnt/DATA/sharedfolder/candump-landrover-discovery-3-vcan0.log
Environment=LOG_INTERFACE=slcan0

ExecStartPre=modprobe vcan
ExecStartPre=-ip link add dev vcan0 type vcan 
ExecStartPre=ip link set up vcan0
ExecStart=canplayer -I $CANDATA -l i vcan0=${LOG_INTERFACE}

ExecStop=/bin/kill -s TERM $MAINPID
PIDFile=/run/cansim/cansim.pid
TimeoutStopSec=0
</code></pre>
<p>Now I can start the simulation whenever I need it with</p>
<pre><code class="language-bash">systemctl start cansim
</code></pre>
</div></article></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"frontmatter":{"title":"Virtual CAN-BUS simulator (Virtual ECU)","date":"May 1, 2020","excerpt":"","author":"Brendan","cover_image":"https://blog.brendanscullion.com/_next/image?url=https%3A%2F%2Fcdn.hashnode.com%2Fres%2Fhashnode%2Fimage%2Funsplash%2FKVPRz5JEDbc%2Fupload%2Fv1652106957021%2FtZQ5ZUVIo.jpeg%3Fw%3D1600%26h%3D840%26fit%3Dcrop%26crop%3Dentropy%26auto%3Dcompress%2Cformat%26format%3Dwebp\u0026w=1920\u0026q=75"},"slug":"canbus_simulator","content":"\nWhile developing some monitoring application for a Raspberry-Pi car computer, I found that writing code on my laptop while sitting in the front seat of my car is not the most productive way to do things. What's needed is some sort of virtual ECU, and i have just the solution. \n\n#### In short my solution is this:\n  1. Take a can recording of the car starting up and running for a little while\n  2. Create a virtual can network device\n  3. replay the recording on an infinite loop\n  4. package it up nicely so that I can start the simulation on demand\n![cansim-demo-2.gif](https://cdn.hashnode.com/res/hashnode/image/upload/v1652107126520/ODP7DeD6f.gif)\n\n1. ### Record Some Data\nThis may be different for other cars but for my disco 3, I need to wait 5 minutes after turning the car off for the ECU to go to sleep. \nOnce the ECU is asleep I start the recording. \n```bash\ncandump can0 -l\n```\nI start the car and let it run for 5 minutes or so, later on I’ll redo this and take the car for a spin around the town but for now this is enough for me. so I `CTL-C` the recording and I get a file named `candump-2020-04-14_202239.log`. I rename this to something with a little more meaning (“candump-landrover-discovery-3-vcan0.log”)\n\n2. ### Configure Virtual CAN device\nThe vcan device is basically another network device so configuring it is pretty straight forward. \n```bash\nsudo modprobe vcan\nsudo ip link add dev vcan0 type vcan\nsudo ip link set up vcan0\n```\n3. ### Replay CAN Recording\nNow i just need to replay my recording back into vcan0.\n```bash\ncanplayer -I candump-landrover-discovery-3-vcan0.log -l i vcan0=slcan0\n```\nBy default canplayer will replay the file via the same device that it was captured on (`slcan0`). to get around this i need to specify the `vcan0` as new device, hence `vcan0=slcan0`\n\n4. ### Create cansim service\nFinally I want to be able to start the simulation on demand. I do this by creating a systemd service config\n\n  ```bash\nsudo vim /lib/systemd/system/cansim.service\n```\n\n```bash\n[Unit]\nDescription=Canbus simulator\nAfter=network.target\n\n[Service]\nLabel=cansim\nType=exec\nEnvironment=CANDATA=/mnt/DATA/sharedfolder/candump-landrover-discovery-3-vcan0.log\nEnvironment=LOG_INTERFACE=slcan0\n\nExecStartPre=modprobe vcan\nExecStartPre=-ip link add dev vcan0 type vcan \nExecStartPre=ip link set up vcan0\nExecStart=canplayer -I $CANDATA -l i vcan0=${LOG_INTERFACE}\n\nExecStop=/bin/kill -s TERM $MAINPID\nPIDFile=/run/cansim/cansim.pid\nTimeoutStopSec=0\n```\nNow I can start the simulation whenever I need it with\n```bash\nsystemctl start cansim\n```"},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"canbus_simulator"},"buildId":"u0JvOxob0c2afmijk8C1k","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>